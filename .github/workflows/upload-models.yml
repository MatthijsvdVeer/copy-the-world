on:
  workflow_dispatch:
name: üî• Reset Azure Digital Twins Content
env:
  DOTNET_VERSION: '6.0' 
  ARTIFACT_DIR: './artifacts'

jobs:
  build-provisioning:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@main
    - name: üîß Setup DotNet ${{ env.DOTNET_VERSION }} Environment
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: üèóÔ∏è Build Solution
      shell: pwsh
      run: |
        mkdir ${{ env.ARTIFACT_DIR }}
        dotnet publish ./src/CopyTheWorld/CopyTheWorld.Provisioning/CopyTheWorld.Provisioning.csproj --configuration Release --sc -r win-x64
        Copy-Item -Path "./src/CopyTheWorld/CopyTheWorld.Provisioning/bin/Release/net6.0/win-x64/*" -Destination "${{ env.ARTIFACT_DIR }}" -Recurse
    - name: ‚¨ÜÔ∏è Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: artifacts
        path: ${{ env.ARTIFACT_DIR }}
  reset-digital-twins:
    runs-on: windows-latest
    needs: [build-provisioning]
    steps:
    - uses: actions/checkout@v3

    - name: ‚¨áÔ∏è Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: artifacts

    - uses: üîë azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: üíæ Install Azure IoT Extension
      shell: pwsh
      run: az extension add -n azure-iot

    - name: üî• Reset Azure Digital Twins
      shell: pwsh
      run: |
        $adtName = az dt list -g ${{ secrets.AZURE_RESOURCE_GROUP_NAME }} --query [0].name --output tsv
        az dt twin delete-all -n $adtName -g ${{ secrets.AZURE_RESOURCE_GROUP_NAME }} -y
        az dt model delete-all -n $adtName -g ${{ secrets.AZURE_RESOURCE_GROUP_NAME }} -y
        az dt model create -n $adtName -g ${{ secrets.AZURE_RESOURCE_GROUP_NAME }} --fd ./ontology
        
    - name: üê£ Create new twins and relationships
      shell: pwsh
      run: |
        $adtEndpoint = az dt list -g ${{ secrets.AZURE_RESOURCE_GROUP_NAME }} --query [0].hostName --output tsv
        CopyTheWorld.Provisioning populate --file "./config/ctw.xlsx" --adtEndpoint https://$adtEndpoint